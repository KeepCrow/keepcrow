---
layout: framework
sidebar: category-list
title:  "Let's Build a Simple Interpreter ç¬¬ä¸‰ç« "
date:   2025-03-01 21:40:46 +0800
categories: Interpreter
---

ä»Šæ—©é†’æ¥ï¼Œæˆ‘å¿ƒè¡€æ¥æ½®é—®æˆ‘è‡ªå·±ï¼š"ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¼šè§‰å¾—æ–°æŠ€èƒ½è¿™ä¹ˆéš¾å­¦å‘¢ï¼Ÿ"

æˆ‘è®¤ä¸ºä¸ä»…ä»…æ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦ä»˜å‡ºè‰°è‹¦åœ°åŠªåŠ›ï¼Œè¿˜æœ‰ä¸€ä¸ªåŸå› æ˜¯æˆ‘ä»¬æŠŠå¤§é‡æ—¶é—´èŠ±åœ¨äº†å­¦ä¹ ç†è®ºçŸ¥è¯†ï¼Œå´æ²¡æœ‰é€šè¿‡ç»ƒä¹ æŠŠçŸ¥è¯†è½¬åŒ–ä¸ºæŠ€èƒ½ã€‚ä»¥æ¸¸æ³³ä¸ºä¾‹ï¼Œå³ä½¿ä½ èŠ±è´¹å‡ ç™¾ä¸ªå°æ—¶å»çœ‹æ¸¸æ³³çš„ä¸“ä¸šä¹¦ç±ï¼Œè§‚çœ‹æ¸¸æ³³æ•™å­¦è§†é¢‘ï¼Œç”šè‡³å’Œä¸“ä¸šæ¸¸æ³³æ•™ç»ƒäº¤æµï¼Œç¬¬ä¸€æ¬¡ä¸‹æ°´ï¼Œä½ è¿˜æ˜¯ä¼šè·Ÿä¸ªçŸ³å¤´ä¸€æ ·æ²‰ä¸‹å»ğŸ˜

è€è¯è¯´å¾—å¥½ï¼Œ*ç»éªŒå¤§ä¼¼å­¦é—®*ã€‚ä¸ç®¡ä½ è§‰å¾—è‡ªå·±å¯¹ä¸€é—¨å­¦ç§‘æœ‰å¤šäº†è§£ï¼Œéƒ½åº”è¯¥åŠ¨æ‰‹å»åšï¼ŒæŠŠçŸ¥è¯†è½¬åŒ–ä¸ºçœŸæ­£çš„æŠ€èƒ½ã€‚ä¸ºäº†è®©ä½ è¾¾æˆè¿™ä¸€ç›®æ ‡ï¼Œæˆ‘åœ¨[ç¬¬ä¸€ç« ](ç¬¬ä¸€ç« .md)å’Œ[ç¬¬äºŒç« ](ç¬¬äºŒç« .md)ä¸­åŠ å…¥äº†ç»ƒä¹ ã€‚å¹¶ä¸”æˆ‘ä¿è¯ï¼Œåœ¨æœªæ¥çš„æ–‡ç« ä¸­ï¼Œä½ ä¼šçœ‹åˆ°æ›´å¤šçš„ç»ƒä¹ ğŸ™‚

å¥½äº†ï¼Œç°åœ¨æ­£å¼å¼€å§‹ä»Šå¤©çš„å†…å®¹ã€‚

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä½ å·²ç»å­¦ä¼šäº†å¦‚ä½•è§£é‡Šä¸¤ä¸ªæ•´æ•°ç›¸åŠ æˆ–ç›¸å‡çš„ç®—æœ¯è¡¨è¾¾å¼ï¼Œå¦‚ "7 + 3 "æˆ– "12 - 9"ã€‚ä»Šå¤©ï¼Œæˆ‘å°†ä»‹ç»å¦‚ä½•è§£æï¼ˆè¯†åˆ«ï¼‰å’Œè§£é‡ŠåŒ…å«ä»»æ„æ•°é‡åŠ å‡è¿ç®—ç¬¦çš„ç®—æœ¯è¡¨è¾¾å¼ï¼Œä¾‹å¦‚ "7 - 3 + 2 - 1"ã€‚
æœ¬æ–‡ä¸­çš„ç®—æœ¯è¡¨è¾¾å¼å¯ä»¥ç”¨ä¸‹é¢çš„è¯­æ³•å›¾è¡¨ç¤ºï¼š

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å­¦ä¹ äº†å¦‚ä½•è§£é‡Šå¦‚"7 + 3"å’Œ"12 + 9"ä¸€ç±»çš„æ•´æ•°åŠ å‡æ³•è¡¨è¾¾å¼ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•è§£é‡Šå››åˆ™è¿ç®—è¡¨è¾¾å¼â€¦â€¦ä¸­çš„åŠ å‡æ³•è¡¨è¾¾å¼ï¼Œæ¯”å¦‚"7 - 3 + 2 - 1"ï¼ˆä¹˜é™¤æ³•æ”¹æ—¥å†è¯´ï¼‰ã€‚

ç†è®ºä¸Šæ¥è¯´ï¼Œå››åˆ™è¿ç®—è¡¨è¾¾å¼ä¸­çš„é¡¹å‡ºç°çš„æ¬¡æ•°åº”è¯¥æ˜¯ä¸é™æ¬¡çš„ï¼ŒåŠ å‡ç¬¦å·ä¹Ÿæ˜¯å¦‚æ­¤ã€‚å¦‚æœæˆ‘ä»¬ç”¨æµç¨‹å›¾æ¥è¡¨ç¤ºçš„è¯ï¼Œå¤§æ¦‚å¦‚å›¾æ‰€ç¤ºï¼š
![å›¾3.1](/assets/images/3.1.png)

ä½ å¯ä»¥éšä¾¿å†™ä¸€ä¸ªè¡¨è¾¾å¼ï¼ˆä¸è¦æœ‰ä¹˜é™¤æ³•å’Œæ‹¬å·è°¢è°¢ï¼‰ï¼Œå®ƒä¸€å®šå¯ä»¥ç”¨ä¸Šé¢è¿™ä¸ªå›¾è¡¨è¾¾ï¼š
1. ç¬¬ä¸€ä¸ªè‚¯å®šæ˜¯é¡¹ï¼Œä¹Ÿå°±æ˜¯å›¾ä¸­çš„ termï¼›
2. åé¢å¯èƒ½æ²¡æœ‰å…¶ä»–çš„è¿ç®—ï¼Œä¾‹å¦‚è¡¨è¾¾å¼"3"å°±åªæœ‰ä¸€ä¸ªé¡¹ï¼Œä¹Ÿå°±æ˜¯å›¾ä¸­æœ€ä¸Šé¢çš„è·¯çº¿
3. æˆ–è€…åé¢è·Ÿç€å…¶ä»–è¿ç®—ï¼Œä¹Ÿå°±æ˜¯ä¼šæœ‰è¿ç®—ç¬¦å·å’Œå¦ä¸€ä¸ªé¡¹
4. å†ç„¶ååé¢å¯èƒ½æ²¡æœ‰å…¶ä»–è¿ç®—ï¼Œä¾‹å¦‚è¡¨è¾¾å¼"3 + 4"å°±åªæœ‰ä¸¤ä¸ªé¡¹ä¸€ä¸ªè¿ç®—ç¬¦
5. å½“ç„¶ä¹Ÿå¯èƒ½è¿˜æœ‰å…¶ä»–çš„è¿ç®—ï¼Œä¾‹å¦‚è¡¨è¾¾å¼"7 - 3 + 2 â€” 1"ï¼Œå°±æ˜¯èµ°å›¾ä¸­æœ€ä¸‹é¢çš„è·¯çº¿

ä¸Šé¢è¿™ç§æµç¨‹å›¾çš„ä¸“ä¸šåè¯å«**è¯­æ³•å›¾**ï¼Œæ‰€è°“è¯­æ³•å›¾ï¼Œå°±æ˜¯èƒ½å¤Ÿè¡¨è¾¾ç¼–ç¨‹è¯­è¨€è¯­æ³•è§„åˆ™çš„å›¾ã€‚

ä¸ºä»€ä¹ˆè¦ä»‹ç»è¿™ä¹ˆä¸ªä¸œè¥¿ï¼Ÿä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ä¸ªåŸå› ï¼š
1. è¯­æ³•å›¾èƒ½ä»¥å›¾å½¢çš„æ–¹å¼å‡†ç¡®ç›´è§‚åœ°å‘Šè¯‰è¯»è€…ï¼Œæˆ‘ä»¬çš„ç¼–ç¨‹è¯­è¨€æ”¯æŒå“ªäº›è¯­æ³•ï¼Œä¸æ”¯æŒå“ªäº›è¯­æ³•ã€‚æ¯”å¦‚è¯´ï¼Œç›®å‰æˆ‘ä»¬çš„è§£é‡Šå™¨ï¼ˆè®¡ç®—å™¨ï¼‰ä»…èƒ½è¯†åˆ«åŒ…å«åŠ å‡æ³•çš„æ•°å­¦è¡¨è¾¾å¼ã€‚è€Œåˆ«äººçœ‹åˆ°è¿™ä¸ªè¯­æ³•å›¾å°±çŸ¥é“ï¼Œå¦‚æœåœ¨é¡¹åé¢è·Ÿä¸Šä¸€ä¸ªä¹˜æ³•å·ï¼Œæˆ–è€…åœ¨è¡¨è¾¾å¼çš„å¼€å¤´ç»™ä¸ªåŠ æ³•å·ï¼Œæˆ‘ä»¬çš„è§£é‡Šå™¨éƒ½æ˜¯æ— æ³•è¿›è¡Œè§£é‡Šçš„ã€‚
2. è¯­æ³•å›¾å®¹æ˜“ç†è§£ï¼šä½ åªè¦è·Ÿç€å›¾ä¸­çš„ç®­å¤´èµ°å°±è¡Œï¼Œæœ‰åˆ†å‰çš„åœ°æ–¹è¡¨ç¤ºæœ‰å¤šç§å¯èƒ½ï¼Œæœ‰å›å¤´çš„åœ°æ–¹å°±è¡¨ç¤ºæœ‰å¾ªç¯ã€‚
3. æœ€é‡è¦çš„åŸå› æ˜¯ï¼Œè¯­æ³•å›¾æ˜¯ç¼–å†™è§£é‡Šå™¨çš„é‡è¦ä¸€æ­¥ã€‚æœ‰äº†è¯­æ³•å›¾ï¼Œä½ å‡ ä¹å¯ä»¥æ— è„‘åœ°æŠŠå®ƒæ˜ å°„åˆ°ä½ çš„ä»£ç ä¸­ï¼Œå®Œæˆè¯­ä¹‰è§£æçš„å·¥ä½œã€‚

å‰é¢æˆ‘ä»¬ä»‹ç»åˆ°ï¼Œåœ¨è¯å…ƒæµä¸­è¯†åˆ«çŸ­è¯­çš„è¿‡ç¨‹å«åš**è§£æ**ã€‚åœ¨è§£é‡Šå™¨ä¸­ï¼Œè´Ÿè´£è¿™éƒ¨åˆ†å·¥ä½œçš„æ¨¡å—å«åš**è§£æå™¨ï¼ˆParserï¼‰**ã€‚å®é™…ä¸Šè§£æåˆè¢«å«åš**è¯­æ³•åˆ†æ**ï¼Œå› ä¸ºå®ƒåšçš„äº‹å°±æ˜¯åœ¨åˆ†æè¯­æ³•æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚é‚£ä¹ˆåŒç†ï¼Œè§£æå™¨ä¹Ÿå¯ä»¥å«åš**è¯­æ³•åˆ†æå™¨**ã€‚

å› ä¸ºæ¯ä¸ªç¼–ç¨‹è¯­è¨€çš„ç®—æœ¯è¡¨è¾¾å¼çš„è¯­æ³•éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œæ‰€ä»¥ä½ å¯ä»¥æš‚æ—¶åœ¨ Python ä¸­"æµ‹è¯•"ä¸€ä¸‹æˆ‘ä»¬çš„è¯­æ³•å›¾ã€‚åœ¨å‘½ä»¤è¡Œé‡Œé¢å¯åŠ¨ Pythonï¼Œç„¶åè‡ªå·±å†™å‡ ä¸ªç¬¦åˆæˆ‘ä»¬è¯­æ³•å›¾çš„æ•°å­¦è¡¨è¾¾å¼ï¼š
```shell
>>> 3
3
>>> 3 + 4
7
>>> 7 - 3 + 2 - 1
5
```

å—¯ï¼ŒPython åŒå­¦ç®—å¾—ä¸é”™ğŸ˜ã€‚

ç®—æœ¯å¼"3+"ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„æ•°å­¦è¡¨è¾¾å¼ï¼Œå› ä¸ºæŒ‰ç…§è¯­æ³•å›¾ï¼ˆå›¾3.1ï¼‰çš„è¯­æ³•æ¥çœ‹ï¼ŒåŠ æ³•å·åé¢åº”è¯¥ç´§è·Ÿç€ä¸€ä¸ªé¡¹ï¼Œå¦åˆ™å°±æ˜¯è¯­æ³•é”™è¯¯ã€‚åœ¨ Ptyon ä¸­æµ‹è¯•ä¸€ä¸‹ï¼Œä½ ä¹Ÿå¯ä»¥çœ‹åˆ°å…³äºè¯­æ³•é”™è¯¯çš„æç¤ºï¼š
```shell
>>> 3 +
  File "<stdin>", line 1
    3 +
      ^
SyntaxError: invalid syntax
```

ç”¨ Python æ¥è¿›è¡Œæµ‹è¯•å›ºç„¶å¾ˆçˆ½ï¼Œä½†æ¯•ç«Ÿä¸æ˜¯æˆ‘ä»¬çš„ç›®çš„ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æŠŠè¯­æ³•å›¾è½¬åŒ–ä¸ºä»£ç ï¼Œç„¶åç”¨æˆ‘ä»¬è‡ªå·±çš„è§£é‡Šå™¨æ¥è¿›è¡Œæµ‹è¯•ï¼ŒæœŸå¾…ä¸€ä¸‹å§ï¼ğŸ˜¼

åœ¨å‰é¢çš„æ–‡ç« é‡Œï¼ˆ[ç¬¬ä¸€ç« ](ç¬¬ä¸€ç« .md)ä¸[ç¬¬äºŒç« ](ç¬¬äºŒç« .md)ï¼‰ï¼Œ`expr` å‡½æ•°æ—¢æ˜¯è§£æå™¨ä¹Ÿæ˜¯è§£é‡Šå™¨ï¼Œå› ä¸ºå®ƒè¦å…ˆä»è¯å…ƒæµä¸­è§£æå‡ºç‰¹å®šçš„è¯­æ³•ï¼ˆè§£æå™¨ï¼‰ï¼Œç„¶åå†æ ¹æ®è¯­æ³•è§£é‡Šå‡ºæœ€ç»ˆçš„ç»“æœï¼ˆè§£é‡Šå™¨ï¼‰ã€‚

ä¸‹é¢çš„ä»£ç ç‰‡æ®µå±•ç¤ºäº†è¯­æ³•å›¾å¯¹åº”çš„ä»£ç ã€‚ä¸ºäº†èƒ½å’Œè¯­æ³•å›¾ä¸€ä¸€å¯¹åº”ï¼Œæˆ‘ä»¬ç”¨ `term` å‡½æ•°æ¥è´Ÿè´£ term çŸ©å½¢æ¡†ä¸­çš„å·¥ä½œï¼šè§£ææ•´æ•°ã€‚è€Œ `expr` å‡½æ•°åˆ™ä»…è´Ÿè´£æ‰§è¡Œè¯­æ³•å›¾çš„ä¸»æµç¨‹ï¼š
```python
def term(self):
    self.eat(INTEGER)

def expr(self):
    # å°†å½“å‰è¯å…ƒè®¾ç½®ä¸ºä»è¾“å…¥è§£æå‡ºçš„ç¬¬ä¸€ä¸ªè¯å…ƒ
    self.current_token = self.get_next_token()

    self.term()
    while self.current_token.type in (PLUS, MINUS):
        token = self.current_token
        if token.type == PLUS:
            self.eat(PLUS)
            self.term()
        elif token.type == MINUS:
            self.eat(MINUS)
            self.term()
```

å¯ä»¥çœ‹åˆ°ï¼Œ`expr` å‡½æ•°å…ˆè°ƒç”¨äº† `term` å‡½æ•°ï¼Œç„¶åç”¨ä¸€ä¸ª `while` å¾ªç¯æ¥åšåç»­çš„è¿ç®—ï¼Œè¿™ä¸ª `while` å¾ªç¯ä¼šæ‰§è¡Œ0åˆ°å¤šæ¬¡ã€‚åœ¨å¾ªç¯ä½“ä¸­ï¼Œè§£æå™¨åŸºäºè¯å…ƒçš„å€¼ï¼ˆåŠ æ³•å·æˆ–å‡æ³•å·ï¼‰åšå‡ºä¸åŒçš„åŠ¨ä½œã€‚ä½ å¯ä»¥èŠ±ç‚¹æ—¶é—´ç¡®è®¤ä¸€ä¸‹ï¼Œä»£ç æ˜¯å¦çœŸçš„å®ç°äº†è¯­æ³•å›¾è¡¨ç¤ºçš„è¯­æ³•ã€‚

ä¸è¿‡ä¸Šè¿°ä»£ç ä½œä¸ºè§£æå™¨å¹¶æ²¡æœ‰è§£é‡Šçš„åŠŸèƒ½ï¼Œå¦‚æœè¾“å…¥çš„è¯­æ³•æ­£ç¡®ï¼Œå®ƒå•¥ä¹Ÿä¸å¹²ï¼Œå¦‚æœè¯­æ³•ä¸æ­£ç¡®ï¼Œå®ƒä¼šæŠ¥é”™ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ä¸€ä¸‹ `expr` å‡½æ•°ï¼Œå¢åŠ è§£é‡Šçš„ä»£ç ï¼Œè®©å®ƒå…·æœ‰è§£é‡Šå™¨çš„åŠŸèƒ½ï¼š
```python
def term(self):
    """è¿”å›ä¸€ä¸ª INTEGER è¯å…ƒçš„å€¼"""
    token = self.current_token
    self.eat(INTEGER)
    return token.value

def expr(self):
    """è§£æå™¨ / è§£é‡Šå™¨ """
    # å°†å½“å‰è¯å…ƒè®¾ç½®ä¸ºä»è¾“å…¥è§£æå‡ºçš„ç¬¬ä¸€ä¸ªè¯å…ƒ
    self.current_token = self.get_next_token()

    result = self.term()
    while self.current_token.type in (PLUS, MINUS):
        token = self.current_token
        if token.type == PLUS:
            self.eat(PLUS)
            result = result + self.term()
        elif token.type == MINUS:
            self.eat(MINUS)
            result = result - self.term()

    return result
```

è€ƒè™‘åˆ°è§£é‡Šå™¨è¦è®¡ç®—è¡¨è¾¾å¼çš„å€¼ï¼Œæ‰€ä»¥ä¿®æ”¹äº† `term`ï¼Œä½¿å…¶å¯ä»¥è¿”å›ä¸€ä¸ªæ•´å‹ï¼›ç„¶åä¿®æ”¹äº†ä¸€ä¸‹ `expr` å‡½æ•°ï¼Œä½¿å…¶å¯ä»¥åœ¨åˆé€‚çš„åœ°æ–¹è¿›è¡ŒåŠ å‡æ³•è¿ç®—ï¼Œå¹¶åœ¨å‡½æ•°ç»“æŸçš„æ—¶å€™è¿”å›ç»“æœã€‚è™½ç„¶ä»£ç çœ‹èµ·æ¥ååˆ†ç®€å•æ˜“æ‡‚ï¼Œä½†æˆ‘è¿˜æ˜¯å»ºè®®ä½ èŠ±ç‚¹æ—¶é—´ä»”ç»†çœ‹çœ‹ğŸ’–ã€‚

å¥½äº†ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å®Œæ•´ä»£ç ã€‚

ä¸‹é¢æ˜¯æ–°ç‰ˆæœ¬çš„è®¡ç®—å™¨æºç ï¼Œä¸ç®¡ç®—æœ¯è¡¨è¾¾å¼æœ‰å¤šé•¿ï¼Œåªè¦åˆæ³•ï¼Œå®ƒéƒ½èƒ½æ­£ç¡®è§£é‡Šï¼š
```python
# è¯å…ƒç±»å‹
# EOF (end-of-file)è¡¨ç¤ºè¯æ³•åˆ†æå·²ç»ç»“æŸ
INTEGER, PLUS, MINUS, EOF = 'INTEGER', 'PLUS', 'MINUS', 'EOF'

class Token(object):
    def __init__(self, type, value):
        # è¯å…ƒç±»å‹: INTEGER, PLUS, or EOF
        self.type = type
        # è¯å…ƒå–å€¼: éè´Ÿæ•´æ•°, '+', '-', or None
        self.value = value

    def __str__(self):
        """è¯å…ƒå¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨è¾¾.
        ä¾‹:
            Token(INTEGER, 3)
            Token(PLUS, '+')
        """
        return 'Token({type}, {value})'.format(
            type=self.type,
            value=repr(self.value)
        )

    def __repr__(self):
        return self.__str__()

class Interpreter(object):
    def __init__(self, text):
        # å‘½ä»¤è¡Œè¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼š"3 + 5", "12 - 5 + 3"
        self.text = text
        # self.posæ˜¯self.textçš„ä¸‹æ ‡
        self.pos = 0
        # å½“å‰æ­£åœ¨å¤„ç†çš„è¯å…ƒ
        self.current_token = None
        self.current_char = self.text[self.pos]

    ##########################################################
    # è¯æ³•è§£æå™¨ä»£ç                                            #
    ##########################################################
    def error(self):
        raise Exception('Invalid syntax')

    def advance(self):
        """'pos'æŒ‡é’ˆå‰ç§»ï¼Œå¹¶ä¸º'current_char'èµ‹å€¼"""
        self.pos += 1
        if self.pos > len(self.text) - 1:
            self.current_char = None  # Indicates end of input
        else:
            self.current_char = self.text[self.pos]

    def skip_whitespace(self):
        while self.current_char is not None and self.current_char.isspace():
            self.advance()

    def integer(self):
        """è¿”å›ä¸€ä¸ªä»è¾“å…¥ä¸­è·å–çš„å¤šä½æ•´æ•°"""
        result = ''
        while self.current_char is not None and self.current_char.isdigit():
            result += self.current_char
            self.advance()
        return int(result)

    def get_next_token(self):
        """è¯æ³•è§£æå™¨ï¼ˆåˆ«åï¼Œtokenizerï¼‰
        è¯¥å‡½æ•°è´Ÿè´£å°†å­—ç¬¦ä¸²åˆ†è§£æˆä¸€ä¸ªä¸ªè¯å…ƒ
        æ¯æ¬¡è°ƒç”¨è¿”å›ä¸€ä¸ªè¯å…ƒ
        """
        while self.current_char is not None:

            if self.current_char.isspace():
                self.skip_whitespace()
                continue

            if self.current_char.isdigit():
                return Token(INTEGER, self.integer())

            if self.current_char == '+':
                self.advance()
                return Token(PLUS, '+')

            if self.current_char == '-':
                self.advance()
                return Token(MINUS, '-')

            self.error()

        return Token(EOF, None)

    ##########################################################
    # è§£æå™¨/è§£é‡Šå™¨ä»£ç                                         #
    ##########################################################
    def eat(self, token_type):
        # å°†ä¼ å…¥çš„è¯å…ƒç±»å‹äºå½“å‰çš„è¯å…ƒç±»å‹è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœåŒ¹é…æˆåŠŸï¼Œ
        # é‚£ä¹ˆå°±"åƒæ‰"å½“å‰çš„è¯å…ƒï¼Œç„¶åæŠŠä¸‹ä¸€ä¸ªè¯å…ƒèµ‹å€¼ç»™self.current_token
        # å¦åˆ™æŠ¥é”™
        if self.current_token.type == token_type:
            self.current_token = self.get_next_token()
        else:
            self.error()

    def term(self):
        """è¿”å›ä¸€ä¸ª INTEGER è¯å…ƒçš„å€¼."""
        token = self.current_token
        self.eat(INTEGER)
        return token.value

    def expr(self):
        """ç®—æœ¯è¡¨è¾¾å¼è§£æå™¨ / è§£é‡Šå™¨."""
	    # å°†å½“å‰è¯å…ƒè®¾ç½®ä¸ºä»è¾“å…¥è§£æå‡ºçš„ç¬¬ä¸€ä¸ªè¯å…ƒ
        self.current_token = self.get_next_token()

        result = self.term()
        while self.current_token.type in (PLUS, MINUS):
            token = self.current_token
            if token.type == PLUS:
                self.eat(PLUS)
                result = result + self.term()
            elif token.type == MINUS:
                self.eat(MINUS)
                result = result - self.term()

        return result

def main():
    while True:
        try:
            text = input('calc> ')
        except EOFError:
            break
        if not text:
            continue
        interpreter = Interpreter(text)
        result = interpreter.expr()
        print(result)

if __name__ == '__main__':
    main()
```

æŠŠä¸Šè¿°ä»£ç ä¿å­˜åˆ°`cal3.py`æ–‡ä»¶ä¸­ï¼Œæˆ–è€…ç›´æ¥ä» [GitHub](https://github.com/rspivak/lsbasi/blob/master/part3/calc3.py) ä¸­ä¸‹è½½ã€‚è‡ªå·±è¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹å®ƒèƒ½ä¸èƒ½å¤„ç†ç¬¦åˆå‰é¢è¯­æ³•å›¾çš„è¡¨è¾¾å¼ã€‚

ä¸‹é¢æ˜¯æˆ‘åœ¨è‡ªå·±çš„ç”µè„‘ä¸Šè¿›è¡Œçš„ä¼šè¯ï¼š
```shell
$ python calc3.py
calc> 3
3
calc> 7 - 4
3
calc> 10 + 5
15
calc> 7 - 3 + 2 - 1
5
calc> 10 + 1 + 2 - 3 + 4 + 6 - 15
5
calc> 3 +
Traceback (most recent call last):
  File "calc3.py", line 147, in <module>
    main()
  File "calc3.py", line 142, in main
    result = interpreter.expr()
  File "calc3.py", line 123, in expr
    result = result + self.term()
  File "calc3.py", line 110, in term
    self.eat(INTEGER)
  File "calc3.py", line 105, in eat
    self.error()
  File "calc3.py", line 45, in error
    raise Exception('Invalid syntax')
Exception: Invalid syntax
```

è¿˜è®°å¾—æˆ‘åœ¨å¼€å¤´çš„æ—¶å€™æåˆ°çš„ç»ƒä¹ å—ï¼Ÿæˆ‘éµå®ˆäº†æˆ‘çš„æ‰¿è¯ºï¼Œä½ ä¹Ÿä¼šå—ï¼ˆç¬¬ä¸€ç« ç»“æŸï¼‰ğŸ˜‹ï¼Ÿ
![å›¾3.2](/assets/images/3.2.png)

- ç»˜åˆ¶ä¸€ä¸ªä»…è¯†åˆ«ä¹˜é™¤æ³•çš„è¯­æ³•å›¾ï¼Œä¾‹å¦‚"7 * 4 / 2 * 3"ï¼Œæˆ‘çœŸçš„å¼ºçƒˆå»ºè®®ä½ åŠ¨æ‰‹åœ¨çº¸ä¸Šç”»ä¸€ä¸ªå‡ºæ¥ã€‚
- ä¿®æ”¹æºä»£ç ï¼Œä½¿å…¶ç¬¦åˆä½ ç»˜åˆ¶çš„è¯­æ³•å›¾
- ä»å¤´ç¼–å†™ä¸€ä¸ªå¯ä»¥å¤„ç†åŠ å‡æ³•æ•°å­¦è¡¨è¾¾å¼çš„è§£é‡Šå™¨ï¼Œä¸çœ‹ä»»ä½•ç¤ºä¾‹ï¼Œè‡ªå·±ç¼–å†™ï¼Œå°±ç”¨ä½ ç”¨ç€æœ€èˆ’æœçš„è¯­è¨€ã€‚åœ¨åšçš„è¿‡ç¨‹ä¸­ï¼Œæ—¶åˆ»æƒ³ç€é‚£äº›å…³é”®æ¨¡å—ï¼š
	- è¯æ³•è§£æå™¨ï¼šå°†è¾“å…¥çš„å­—ç¬¦ä¸²è§£æä¸ºè¯å…ƒæµ
	- è§£æå™¨ï¼šä»è¯æ³•è§£æå™¨è¾“å‡ºçš„è¯å…ƒæµä¸­è¯†åˆ«å‡ºå›ºå®šæ ¼å¼çš„è¯­å¥
	- è§£é‡Šå™¨ï¼šæ ¹æ®è§£æå™¨è¯†åˆ«çš„çŸ­è¯­ç”Ÿæˆæœ€ç»ˆç»“æœ
	ç„¶åæŠŠè¿™äº›æ¨¡å—ç»„åˆèµ·æ¥ã€‚
ç›¸ä¿¡æˆ‘ï¼ŒèŠ±äº›æ—¶é—´æŠŠä½ è·å–åˆ°çš„çŸ¥è¯†è½¬åŒ–ä¸ºä¸€ä¸ªå¯ç”¨çš„æ•°å­¦è¡¨è¾¾å¼è§£é‡Šå™¨ä¼šå¾ˆæœ‰ç”¨ã€‚

æ£€æŸ¥ä¸€ä¸‹è‡ªå·±çš„ç†è§£ï¼š
1. ä»€ä¹ˆæ˜¯è¯­æ³•å›¾
2. ä»€ä¹ˆæ˜¯è¯­æ³•åˆ†æ
3. ä»€ä¹ˆæ˜¯è¯­æ³•åˆ†æå™¨

æ–‡ç« å°±è¦ç»“æŸäº†ï¼Œæ„Ÿè°¢ä½ èƒ½åšæŒåˆ°è¿™é‡Œï¼Œä¸è¦å¿˜è®°åšç»ƒä¹ å“ˆğŸ˜ã€‚æˆ‘å¾ˆå¿«å°±ä¼šå¸¦ç€æ–°çš„æ–‡ç« å½’æ¥ï¼Œæ•¬è¯·æœŸå¾…ã€‚

ä¸‹é¢çš„ä¹¦å•å¯èƒ½ä¼šå¯¹ä½ å­¦ä¹ è§£é‡Šå™¨ä¸ç¼–è¯‘å™¨æœ‰å¸®åŠ©ï¼š
1. [Language Implementation Patterns: Create Your Own Domain-Specific and General Programming Languages (Pragmatic Programmers)](http://www.amazon.com/gp/product/193435645X/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=193435645X&linkCode=as2&tag=russblo0b-20&linkId=MP4DCXDV6DJMEJBL)
2. [Writing Compilers and Interpreters: A Software Engineering Approach](http://www.amazon.com/gp/product/0470177071/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=0470177071&linkCode=as2&tag=russblo0b-20&linkId=UCLGQTPIYSWYKRRM)
3. [Modern Compiler Implementation in Java](http://www.amazon.com/gp/product/052182060X/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=052182060X&linkCode=as2&tag=russblo0b-20&linkId=ZSKKZMV7YWR22NMW)
4. [Modern Compiler Design](http://www.amazon.com/gp/product/1461446988/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=1461446988&linkCode=as2&tag=russblo0b-20&linkId=PAXWJP5WCPZ7RKRD)
5. [Compilers: Principles, Techniques, and Tools (2nd Edition)](http://www.amazon.com/gp/product/0321486811/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=0321486811&linkCode=as2&tag=russblo0b-20&linkId=GOEGDQG4HIHU56FQ)